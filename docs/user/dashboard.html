cat > dashboard.html <<'HTML'
<!doctype html>
<html lang="en"><head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard ‚Äî Refer & Earn</title>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head><body>
<main class="container">
  <header class="card"><div class="row"><h2>Dashboard</h2><button id="logout" class="btn btn-ghost">Logout</button></div></header>

  <section class="card" id="profileCard">
    <h3 id="p_name">User</h3>
    <p>Balance: ‚Ç¶<strong id="p_balance">0</strong> ‚Ä¢ Level: <span id="p_level">1</span> <span id="p_stars">‚≠ê</span></p>
    <p>Your referral link: <input id="p_ref" readonly style="width:60%"></p>
    <button id="copyRef" class="btn">Copy Referral</button>
    <div style="margin-top:10px">
      <label>Upgrade:</label>
      <div class="row">
        <button class="btn" id="upgrade2">Level 2 ‚Äî ‚Ç¶3,000</button>
        <button class="btn" id="upgrade3">Level 3 ‚Äî ‚Ç¶5,000</button>
      </div>
    </div>
  </section>

  <section class="card" id="uploadCard">
    <h3>Create Post</h3>
    <input id="postTitle" placeholder="Title">
    <textarea id="postText" placeholder="Write story..."></textarea>
    <input type="file" id="postImage" accept="image/*">
    <button id="btnPost" class="btn">Upload Post</button>
    <p id="postMsg" class="muted"></p>
  </section>

  <section class="card">
    <h3>Feed</h3>
    <div id="feed">Loading feed...</div>
  </section>

  <section class="card">
    <h3>Withdraw</h3>
    <input id="w_amount" type="number" placeholder="Amount (NGN)"><br>
    <input id="w_account" placeholder="Account / Bank details"><br>
    <button id="btnWithdraw" class="btn">Request Withdrawal</button>
    <p class="muted">Admin approves withdrawals.</p>
  </section>
</main>

<script>
// Firebase v8 config for dashboard (we'll use v8 here to match storage API easily)
const firebaseConfig = {
  apiKey: "AIzaSyBMV7NUVLf-9aEer5jlhqOv5u_Z7XM5oVo",
  authDomain: "refer-and-earn-74706.firebaseapp.com",
  databaseURL: "https://refer-and-earn-74706-default-rtdb.firebaseio.com",
  projectId: "refer-and-earn-74706",
  storageBucket: "refer-and-earn-74706.firebasestorage.app",
  messagingSenderId: "681290792261",
  appId: "1:681290792261:web:982ae0c9f81b7291bc922c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
const PAYSTACK_KEY = 'pk_live_aa0529d581117f84592d7deeaaee3ebac7628a3c';

let currentUser = null;

// UI refs
const p_name = document.getElementById('p_name');
const p_balance = document.getElementById('p_balance');
const p_level = document.getElementById('p_level');
const p_stars = document.getElementById('p_stars');
const p_ref = document.getElementById('p_ref');
const copyRef = document.getElementById('copyRef');
const uploadCard = document.getElementById('uploadCard');
const feed = document.getElementById('feed');
const postMsg = document.getElementById('postMsg');

function calcStars(level){ return '‚≠ê'.repeat(level||1); }
function rewardAmountsForLevel(level){
  if(level==3) return { like:20, comment:40, share:60 };
  if(level==2) return { like:10, comment:20, share:30 };
  return { like:5, comment:10, share:15 };
}

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href='index.html';
  currentUser = user;
  const uid = user.uid;

  db.ref('users/'+uid).on('value', s=>{
    if(!s.exists()) return;
    const u = s.val();
    p_name.innerText = u.name || user.email;
    p_balance.innerText = u.balance || 0;
    p_level.innerText = u.level || 1;
    p_stars.innerText = calcStars(u.level || 1);
    p_ref.value = location.origin + '/index.html?ref=' + uid;
  });

  loadFeed();
});

// logout
document.getElementById('logout').addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html') );

// post upload
document.getElementById('btnPost').addEventListener('click', async ()=>{
  if(!currentUser) return alert('Login');
  const uid = currentUser.uid;
  const title = document.getElementById('postTitle').value.trim();
  const text = document.getElementById('postText').value.trim();
  const file = document.getElementById('postImage').files[0] || null;
  if(!text && !file) return postMsg.innerText = 'Add text or image';
  postMsg.innerText = 'Uploading...';
  try{
    let imageUrl = '';
    if(file){
      const path = 'posts/' + uid + '/' + Date.now() + '_' + file.name.replace(/\s+/g,'_');
      const snap = await storage.ref(path).put(file);
      imageUrl = await snap.ref.getDownloadURL();
    }
    const postRef = db.ref('posts').push();
    await postRef.set({
      authorUid: uid,
      authorName: (await db.ref('users/'+uid).once('value')).val().name || currentUser.email,
      title: title || '',
      text: text || '',
      imageUrl: imageUrl || '',
      likes: 0,
      comments: {},
      shares: 0,
      timestamp: Date.now(),
      status: 'live'
    });
    postMsg.innerText = 'Post uploaded';
    document.getElementById('postTitle').value=''; document.getElementById('postText').value=''; document.getElementById('postImage').value='';
  }catch(err){ postMsg.innerText = 'Post failed: ' + err.message; }
});

// feed + interactions
function loadFeed(){
  db.ref('posts').orderByChild('timestamp').on('value', snap=>{
    feed.innerHTML = '';
    if(!snap.exists()){ feed.innerHTML = '<p>No posts yet</p>'; return; }
    const posts = snap.val();
    Object.keys(posts).sort((a,b)=> posts[b].timestamp - posts[a].timestamp).forEach(id=>{
      const p = posts[id];
      const div = document.createElement('div'); div.className='post-card';
      const imgHtml = p.imageUrl ? `<p><img src="${p.imageUrl}"></p>` : '';
      const commentsCount = p.comments ? Object.keys(p.comments).length : 0;
      div.innerHTML = `
        <h4>${escapeHtml(p.title||'')}</h4><p>${escapeHtml(p.text||'')}</p>${imgHtml}
        <small class="muted">By ${escapeHtml(p.authorName||p.authorEmail)}</small>
        <p>
          <button data-id="${id}" class="likeBtn">üëç <span id="lk-${id}">${p.likes||0}</span></button>
          <button data-id="${id}" class="commentToggle">üí¨ <span id="cm-${id}">${commentsCount}</span></button>
          <button data-id="${id}" class="shareBtn">üîÅ <span id="sh-${id}">${p.shares||0}</span></button>
        </p>
        <div id="comments-${id}" style="display:none;padding:8px"></div>
      `;
      feed.appendChild(div);
    });

    document.querySelectorAll('.likeBtn').forEach(b=> b.onclick = ()=> handleLike(b.dataset.id));
    document.querySelectorAll('.commentToggle').forEach(b=> b.onclick = ()=> toggleComments(b.dataset.id));
    document.querySelectorAll('.shareBtn').forEach(b=> b.onclick = ()=> handleShare(b.dataset.id));
  });
}

async function handleLike(postId){
  if(!currentUser) return alert('Login');
  const pRef = db.ref('posts/'+postId);
  const pSnap = await pRef.once('value'); if(!pSnap.exists()) return;
  const p = pSnap.val(); await pRef.child('likes').set((p.likes||0) + 1);

  // reward liker
  const uSnap = await db.ref('users/'+currentUser.uid).once('value');
  const lvl = uSnap.exists()? (uSnap.val().level||1):1;
  const reward = rewardAmountsForLevel(lvl).like;
  await db.ref('users/'+currentUser.uid+'/balance').transaction(b => Number(b||0) + reward);

  // notify owner
  await db.ref('notifications/'+p.authorUid).push({ message: `${uSnap.val().name||currentUser.email} liked your post (+‚Ç¶${reward})`, at: Date.now() });
}

function toggleComments(postId){
  const box = document.getElementById('comments-'+postId);
  if(box.style.display === 'none' || box.style.display === ''){ box.style.display = 'block'; loadComments(postId); } else box.style.display = 'none';
}

async function loadComments(postId){
  const commentsDiv = document.getElementById('comments-'+postId);
  commentsDiv.innerHTML = `<div style="margin-bottom:8px"><input id="cinput-${postId}" placeholder="Write a comment..." style="width:70%"><button id="cbtn-${postId}" class="btn">Send</button></div><div id="cshow-${postId}"></div>`;
  document.getElementById('cbtn-'+postId).onclick = ()=> sendComment(postId);
  const snap = await db.ref('posts/'+postId+'/comments').once('value');
  const show = document.getElementById('cshow-'+postId); show.innerHTML = '';
  if(!snap.exists()) return;
  const comments = snap.val();
  Object.keys(comments).forEach(cid=>{
    const c = comments[cid];
    const div = document.createElement('div'); div.style.marginBottom='8px';
    div.innerHTML = `<b>${escapeHtml(c.author)}</b>: ${escapeHtml(c.text)} <small class="muted">‚Ä¢ ${new Date(c.at).toLocaleString()}</small>
      <div id="replies-${postId}-${cid}" style="margin-left:12px;margin-top:6px"></div>
      <input id="replyinput-${postId}-${cid}" placeholder="Reply..." style="width:60%"><button class="btn" id="replybtn-${postId}-${cid}">Reply</button>
    `;
    show.appendChild(div);
    loadReplies(postId, cid);
    document.getElementById(`replybtn-${postId}-${cid}`).onclick = async ()=>{
      const txt = document.getElementById(`replyinput-${postId}-${cid}`).value.trim(); if(!txt) return;
      const rRef = db.ref(`posts/${postId}/comments/${cid}/replies`).push();
      await rRef.set({ author: (await db.ref('users/'+currentUser.uid).once('value')).val().name || currentUser.email, text: txt, at: Date.now() });
      const uSnap = await db.ref('users/'+currentUser.uid).once('value'); const lvl = uSnap.exists()? (uSnap.val().level||1):1;
      const reward = rewardAmountsForLevel(lvl).comment;
      await db.ref('users/'+currentUser.uid+'/balance').transaction(b => Number(b||0) + reward);
      await db.ref('notifications/'+c.uid).push({ message: `${uSnap.val().name||currentUser.email} replied (+‚Ç¶${reward})`, at: Date.now() });
      document.getElementById(`replyinput-${postId}-${cid}`).value = '';
      loadReplies(postId, cid);
    };
  });
}

async function loadReplies(postId, cid){
  const rDiv = document.getElementById(`replies-${postId}-${cid}`); rDiv.innerHTML = '';
  const rsnap = await db.ref(`posts/${postId}/comments/${cid}/replies`).once('value');
  if(!rsnap.exists()) return;
  rsnap.forEach(r => rDiv.innerHTML += `<p><small><strong>${escapeHtml(r.val().author)}</strong>: ${escapeHtml(r.val().text)}</small></p>`);
}

async function sendComment(postId){
  if(!currentUser) return alert('Login');
  const input = document.getElementById('cinput-'+postId);
  const text = input.value.trim(); if(!text) return;
  const authorName = (await db.ref('users/'+currentUser.uid).once('value')).val().name || currentUser.email;
  const cRef = db.ref('posts/'+postId+'/comments').push();
  await cRef.set({ uid: currentUser.uid, author: authorName, text, at: Date.now() });
  const uSnap = await db.ref('users/'+currentUser.uid).once('value'); const lvl = uSnap.exists()? (uSnap.val().level||1):1;
  const reward = rewardAmountsForLevel(lvl).comment;
  await db.ref('users/'+currentUser.uid+'/balance').transaction(b => Number(b||0) + reward);
  const postOwner = (await db.ref('posts/'+postId).once('value')).val().authorUid;
  await db.ref('notifications/'+postOwner).push({ message: `${authorName} commented (+‚Ç¶${reward})`, at: Date.now() });
  input.value = ''; loadComments(postId);
}

async function handleShare(postId){
  if(!currentUser) return alert('Login');
  const pRef = db.ref('posts/'+postId); const pSnap = await pRef.once('value'); if(!pSnap.exists()) return;
  await pRef.child('shares').set((pSnap.val().shares||0)+1);
  const uSnap = await db.ref('users/'+currentUser.uid).once('value'); const lvl = uSnap.exists()? (uSnap.val().level||1):1;
  const reward = rewardAmountsForLevel(lvl).share;
  await db.ref('users/'+currentUser.uid+'/balance').transaction(b => Number(b||0) + reward);
  alert(`Share recorded ‚Äî you earned ‚Ç¶${reward}`);
}

// withdrawal
document.getElementById('btnWithdraw').addEventListener('click', async ()=>{
  if(!currentUser) return alert('Login');
  const amt = Number(document.getElementById('w_amount').value);
  const acct = document.getElementById('w_account').value.trim();
  if(!amt || !acct) return alert('Enter amount and account');
  await db.ref('withdrawals').push({ uid: currentUser.uid, amount: amt, account: acct, status: 'pending', createdAt: Date.now() });
  await db.ref('notifications/admin').push({ type:'withdrawRequest', uid: currentUser.uid, amount: amt, account: acct, at: Date.now() });
  alert('Withdrawal requested ‚Äî admin will approve.');
}

// level upgrades via Paystack
document.getElementById('upgrade2').addEventListener('click', ()=> startUpgrade(2,3000));
document.getElementById('upgrade3').addEventListener('click', ()=> startUpgrade(3,5000));
function startUpgrade(level, amount){
  if(!currentUser) return alert('Login');
  const email = currentUser.email;
  const handler = PaystackPop.setup({
    key: PAYSTACK_KEY,
    email,
    amount: amount * 100,
    currency: 'NGN',
    ref: 'lvl_' + currentUser.uid + '_' + Date.now(),
    callback: async function(response){
      await db.ref('users/'+currentUser.uid+'/level').set(level);
      await db.ref('payments').push({ uid: currentUser.uid, level, amount, reference: response.reference, at: Date.now() });
      await db.ref('notifications/'+currentUser.uid).push({ message: `Upgrade to Level ${level} successful`, at: Date.now() });
      alert('Upgrade successful');
    },
    onClose: function(){ alert('Payment closed'); }
  });
  handler.openIframe();
}

// util
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
copyRef.addEventListener('click', ()=> { p_ref.select(); document.execCommand('copy'); alert('Copied'); });
</script>
</body></html>
HTML
